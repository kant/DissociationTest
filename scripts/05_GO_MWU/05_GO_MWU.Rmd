---
title: "GO_MWU.Rmd"
author: "Rayna M Harris"
date: January 7, 2017
output:
  md_document:
  variant: markdown_github
---

GO_MWU uses continuous measure of significance (such as fold-change or -log(p-value) ) to identify GO categories that are significantly enriches with either up- or down-regulated genes. The advantage - no need to impose arbitrary significance cutoff.

If the measure is binary (0 or 1) the script will perform a typical "GO enrichment" analysis based Fisher's exact test: it will show GO categories over-represented among the genes that have 1 as their measure. 

On the plot, different fonts are used to indicate significance and color indicates enrichment with either up (red) or down (blue) regulated genes. No colors are shown for binary measure analysis.

The tree on the plot is hierarchical clustering of GO categories based on shared genes. Categories with no branch length between them are subsets of each other.

The fraction next to GO category name indicates the fracton of "good" genes in it; "good" genes being the ones exceeding the arbitrary absValue cutoff (option in gomwuPlot). For Fisher's based test, specify absValue=0.5. This value does not affect statistics and is used for plotting only.

Stretch the plot manually to match tree to text

Mikhail V. Matz, UT Austin, February 2015; matz@utexas.edu

################################################################


NOTES: This program drains memory and creates some very large intermediate files, especially for the biological process catagory. 

First, I run the stats from the command line to make sure its working. Once I've generated the temp files, I comment out then stats portions and recreate the plots by kniting the rmd file. 

```{r setup}
library(ape)
library(dplyr)
source("gomwu.functions.R")

# set output file for figures 
knitr::opts_chunk$set(fig.path = '../../figures/05_GO_MMU/',
                     eval=F, include=F)
```

## Dissociation vs Homogenization Molecular Function (MF)

```{r MF, eval=T, include=T}
# input files
input="01_dissociation_GOpvals.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision, perlPath="perl", largest=0.1, smallest=5,clusterCutHeight=0.25)  

# many catagories
gomwuPlot(input,goAnnotations,goDivision,
	absValue=-log(0.05,10),  
	level1=0.05, 
	level2=0.05, 
	level3=0.001, 
	txtsize=1.4,    
	treeHeight=0.5, 
  #colors=c("#d9d9d9","#525252","#d9d9d9","#525252")
	#colors=c("blue","green","blue","green") 
	colors=c("dodgerblue2","firebrick1","skyblue","lightcoral") 
)

# fewer catagories
gomwuPlot(input,goAnnotations,goDivision,
	absValue=-log(0.05,10),  
	level1=0.001, 
	level2=0.001, 
	level3=0.0001, 
	txtsize=1.4,    
	treeHeight=0.5, 
  #colors=c("#d9d9d9","#525252","#d9d9d9","#525252")
	#colors=c("blue","green","blue","green") 
	colors=c("dodgerblue2","firebrick1","skyblue","lightcoral") 
)

```

## Dissociation vs Homogenization Molecular Function (MF)

```{r CC, eval=T, include=T}
# input files
input="01_dissociation_GOpvals.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="CC" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision, perlPath="perl", largest=0.1, smallest=5,clusterCutHeight=0.25)  

# Data viz
gomwuPlot(input,goAnnotations,goDivision,
	absValue=-log(0.05,10),  
	level1=0.05, 
	level2=0.05, 
	level3=0.00000001, 
	txtsize=1.4,    
	treeHeight=0.5, 
  #colors=c("#d9d9d9","#525252","#d9d9d9","#525252")
	#colors=c("blue","green","blue","green") 
	colors=c("dodgerblue2","firebrick1","skyblue","lightcoral") 
)

gomwuPlot(input,goAnnotations,goDivision,
	absValue=-log(0.05,10),  
	level1=0.00000001, 
	level2=0.00000001, 
	level3=0.000000001, 
	txtsize=1.4,    
	treeHeight=0.5, 
  #colors=c("#d9d9d9","#525252","#d9d9d9","#525252")
	#colors=c("blue","green","blue","green") 
	colors=c("dodgerblue2","firebrick1","skyblue","lightcoral") 
)
```


## table of significance, top 10 ish Go terms

```{r}
# read and make column for source, bind
cc <- read.csv("goodsCC0.051e-08.csv")
cc$GO <- "CC"
mf <- read.csv("goodsMF0.050.001.csv")
mf$GO <- "MF"
ccff <- bind_rows(cc, mf)

# clean up and reorder columns
ccff$ratio <- sapply(strsplit(as.character(ccff$X),' '), "[", 1) # split on first space
ccff$GOterm <- gsub("\\d+/\\d+","",ccff$X) # remove all numbers
ccff <- ccff[c(6,8,5,7,2)]  

ccff <- ccff %>% 
  arrange(GO,pval) 
ccff$pval <- signif(ccff$pval, digits = 2)
head(ccff)
tail(ccff)

write.csv(ccff, "../../results/GOsignificantcatagories.csv", row.names = F)
## table of significance p < 0.05